# Вопрос 5: Базовые блоки PL/SQL

## Теоретическая часть

### Определение и концепция
**PL/SQL (Procedural Language extensions to SQL)** — это процедурное расширение языка SQL, разработанное корпорацией Oracle. Главная особенность языка — **блочная структура**.

Любая программа на PL/SQL состоит из одного или нескольких блоков. Блок — это базовая единица компиляции и выполнения (логический контейнер кода). Блоки могут быть вложенными друг в друга.

### Типы блоков
1.  **Анонимные блоки (Anonymous Blocks):**
    *   Не имеют имени.
    *   Не хранятся в базе данных.
    *   Компилируются и выполняются "на лету" (например, скрипт, запущенный в SQL*Plus или IDE).
    *   Обычно используются для разовых задач или тестирования логики.

2.  **Именованные блоки (Named Blocks / Subprograms):**
    *   Имеют имя.
    *   Хранятся в базе данных в скомпилированном виде.
    *   Могут вызываться по имени из других блоков или приложений.
    *   **Примеры:** Процедуры (`PROCEDURE`), Функции (`FUNCTION`), Пакеты (`PACKAGE`), Триггеры (`TRIGGER`).

### Структура блока
Каждый блок PL/SQL состоит из трех секций (одна обязательная и две опциональные):

1.  **DECLARE (Секция объявлений) — *Опционально***
    *   Здесь определяются переменные, константы, курсоры и пользовательские исключения, которые будут использоваться в блоке.
    *   Переменные, объявленные здесь, локальны для этого блока.

2.  **BEGIN (Исполняемая секция) — *Обязательно***
    *   Содержит исполняемый код: SQL-запросы (`SELECT INTO`, `INSERT`, `UPDATE`), логические конструкции (`IF`, `LOOP`), вызовы процедур.
    *   Должна содержать хотя бы одну инструкцию (если делать нечего, используется команда `NULL;`).

3.  **EXCEPTION (Секция обработки исключений) — *Опционально***
    *   Здесь перехватываются и обрабатываются ошибки (exception), возникшие в секции `BEGIN`.
    *   Работает аналогично `try-catch` в других языках.

4.  **END; — *Обязательно***
    *   Завершает блок.

---

## Примеры кода (PL/SQL)

### 1. Простейший анонимный блок
Минимальный валидный блок должен содержать `BEGIN` и `END`.

```sql
BEGIN
    -- Включаем вывод на экран (в IDE нужно предварительно включить DBMS Output)
    DBMS_OUTPUT.PUT_LINE('Hello, World!');
    NULL; -- Команда "ничего не делать", нужна, если блок пустой
END;
/
```
*(Слэш `/` в конце часто используется в SQL*Plus/Oracle для запуска блока)*

### 2. Полная структура блока (DECLARE, BEGIN, EXCEPTION)
В этом примере мы объявляем переменную, выполняем выборку данных в неё и обрабатываем возможную ошибку "данные не найдены".

```sql
DECLARE
    -- Секция объявлений
    v_employee_name VARCHAR2(100); -- Переменная для имени
    v_salary        NUMBER;        -- Переменная для зарплаты
    c_target_id     CONSTANT NUMBER := 9999; -- Константа (несуществующий ID)
BEGIN
    -- Исполняемая секция
    DBMS_OUTPUT.PUT_LINE('Поиск сотрудника с ID: ' || c_target_id);

    -- Пытаемся найти сотрудника. 
    -- SELECT INTO обязателен в PL/SQL, если мы хотим сохранить результат запроса
    SELECT first_name, salary 
    INTO v_employee_name, v_salary
    FROM Employees
    WHERE employee_id = c_target_id;

    -- Если строка выше выполнится успешно, код пойдет дальше:
    DBMS_OUTPUT.PUT_LINE('Найден: ' || v_employee_name || ', Зарплата: ' || v_salary);

EXCEPTION
    -- Секция обработки ошибок
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('Ошибка: Сотрудник с таким ID не найден!');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Произошла неизвестная ошибка: ' || SQLERRM);
END;
/
```

### 3. Вложенные блоки (Nested Blocks)
Блоки могут находиться внутри других блоков. Это полезно для ограничения области видимости переменных или локальной обработки ошибок.

```sql
DECLARE
    v_global VARCHAR2(20) := 'Global Variable';
BEGIN
    DBMS_OUTPUT.PUT_LINE('Внешний блок: ' || v_global);

    -- Вложенный (внутренний) блок
    DECLARE
        v_local VARCHAR2(20) := 'Local Variable';
    BEGIN
        -- Здесь видны и глобальная, и локальная переменные
        DBMS_OUTPUT.PUT_LINE('Внутренний блок: ' || v_local);
        DBMS_OUTPUT.PUT_LINE('Внутренний блок видит: ' || v_global);
    END;
    
    -- А здесь v_local уже НЕ ВИДНА (будет ошибка компиляции, если раскомментировать)
    -- DBMS_OUTPUT.PUT_LINE(v_local); 
END;
/
```

